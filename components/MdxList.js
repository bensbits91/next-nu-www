import { useState } from 'react';
import Link from 'next/link';
import { groups } from '../utils/categories';
import dayjs from 'dayjs';
import ItemIcon from './ItemIcon';

export default function MdxList({ items }) {
    const groupsForPage = groups[items[0].pageType],

        [grouping, setGrouping] = useState('skillType'),

        groupSelect = groupsForPage ?
            <ul className='actions stacked'>
                {Object.keys(groupsForPage).map(g =>
                    <li key={g}>
                        <a onClick={() => setGrouping(g)}
                            className={g === grouping ? 'button small active disabled' : 'button small'} >
                            {groupsForPage[g].optionText}
                        </a>
                    </li>
                )}
            </ul> : <></>,

        aList = (items, idx) => {
            return (
                <div key={idx}>
                    <ul>
                        {items.map(item =>
                            <li key={item.slug}>
                                <Link as={`/${item.pageType}/${item.slug.replace(/\.mdx?$/, '')}`}
                                    href={`/${item.pageType}/[slug]`} >
                                    <a>
                                        <span className='icon-wrap'>
                                            <ItemIcon slug={item.slug} />
                                        </span>
                                        {item.title}
                                    </a>
                                </Link>
                            </li>
                        )}
                    </ul>
                </div>)
        };

    return (
        <div className='row'>
            <div className='col-8 col-12-medium'>
                <div className='row mdx-list'>
                    {!groupsForPage && aList(items, '1')}

                    {groupsForPage && groupsForPage[grouping].groups.map((g, idx) => {

                        const filteredItems = function () {
                            switch (grouping) {
                                case 'skillType':
                                    return items.filter(i => g.match.indexOf(i.skillType) > -1)

                                case 'level':
                                    return items.filter(i => g.match.indexOf(i.level) > -1)

                                case 'years':
                                    return items.filter(i => g.match.indexOf(
                                        (i.lastUsed ? dayjs(i.lastUsed).year() : dayjs().year()) - dayjs(i.firstUsed).year() // subtract year first used from EITHER year last used OR year now
                                    ) > -1)
                                    
                                case 'lastUsed':
                                    return items.filter(i => (!i.lastUsed && g.match === dayjs().year()) || g.match === dayjs(i.lastUsed).year())

                                default:
                                    return null
                            }
                        }()

                        return (
                            filteredItems.length > 0 &&
                            <div key={idx} className='col-6 col-12-medium'>
                                <h2>
                                    {g.groupName}
                                </h2>

                                {grouping === 'skillType' &&
                                    aList(filteredItems, idx.toString())
                                }

                                {grouping === 'level' &&
                                    aList(filteredItems, idx.toString())
                                }

                                {grouping === 'years' &&
                                    aList(filteredItems, idx.toString())
                                }

                                {grouping === 'lastUsed' &&
                                    aList(filteredItems, idx.toString())
                                }
                            </div>

                        )
                    })}
                </div>
            </div>

            <div className='col-4 col-12-medium mdx-sidebar'>
                {groupSelect}
            </div>
        </div>
    );
}